<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Degrees of Pynchon</title>
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="style.css" type="text/css">
</head>
<body>
  <h1>Degrees of Pynchon</h1>
  <h2>"Thomas Pynchon loved this graph, almost as much as he loves cameras!"</h2>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="writers.js"></script>
<script>
  var width = 1200,
      height = 550,
      margin = { top: 30, right: 40, bottom: 50, left: 50 };

  var colors = d3.scale.category20b();

  var svg = d3.select('body').append('svg')
    .attr('width', width + margin.right + margin.left)
    .attr('height', height + margin.top + margin.bottom);


  var fadeGraph = function() {
    svg.selectAll('circle').attr('opacity', 0.06);
    svg.selectAll('text').attr('opacity', 0.06);
    svg.selectAll('path').attr('opacity', 0.06);
    svg.selectAll('line').attr('opacity', 0.06);
  };

  var unfadeGraph = function() {
    svg.selectAll('circle').attr('opacity', 1);
    svg.selectAll('text').attr('opacity', 1);
    svg.selectAll('path').attr('opacity', 1);
    svg.selectAll('line').attr('opacity', 1);
  };

  var createGraph = function(data, g, centerColor) {
    var nodes = data.nodes;
    var links = data.links;

    if (nodes.length > 0) {
      var xScale = d3.scale.linear()
        .domain([0, nodes.length])
        .range([0, height]);

      var centerPos = width / 2;

      // Draw nodes
      nodes.forEach(function(d, i) {
        if (d.group === 0) {
          d.x = centerPos;
          d.cx = centerPos;
        } else if (d.group === 1) {
          d.x = -Math.round(xScale(i)) + (centerPos);
          d.cx = d.x + (i * 8);
        } else if (d.group === 2) {      
          d.x = Math.round(xScale(i)) + (centerPos);
          d.cx = d.x + (i * 8);
        }
        d.y = 300;
      });

      g.selectAll('circle')
        .data(nodes)
        .enter()
        .append('circle')
          .attr('fill', function(d, i) {
            if (d.group === 0) {
              return centerColor;
            } else {
              return colors(i); 
            }
          })
          .attr('cx', function(d, i) { return d.cx; })
          .attr('cy', function(d, i) { return d.y; })
          .attr('r', 4);

      g.selectAll('text')
        .data(nodes)
        .enter()
        .append('text')
          .text(function(d, i) {
            if (d.group !== 0) {
              return d.nodeName;
            }
          })
          .attr('class', 'writer')
          .attr('style', function(d, i) {
            return "fill: " + colors(i) + ";";
          })
          .attr('x', function(d, i) { return d.cx; })
          .attr('y', function(d, i) { 
            if (d.group === 1) {
              return d.y + 20;
            } else {
              return d.y - 20; 
            }
          })
          .attr('transform', function(d, i) {
            if (d.group === 1) {
              return 'rotate(90 ' + (d.cx) + ',' + (d.y + 20) + ')'
            } else {
              return 'rotate(-90 ' + (d.cx) + ',' + (d.y - 20) + ')'
            }
          });

      // Draw arcs
      links.forEach(function(d, i) {
        d.x = (nodes[d.source].x - nodes[d.target].x) * 1.2, 
        d.y = nodes[d.source].y - nodes[d.target].y,
        d.r = Math.sqrt(d.x * d.x + d.y * d.y)
      });

      g.selectAll('path')
        .data(links)
        .enter()
        .append('path')
          .style('fill', 'transparent')
          .style('stroke', function(d, i) {
            return colors(i);
          })
          .attr('d', function(d) {
            return 'M ' + nodes[d.source].cx + ', ' + 100 + ' A ' + d.r + ' ' + d.r + ' 0 0 1' + nodes[d.target].cx + ', ' + 100;

          })
          .attr('transform', 'translate(0, 200)'); 

      g.on('mouseleave', function(d) {
        g.remove();
        unfadeGraph();
      });
    }
  }

  var redraw = function(obj) {
    var data = writers[obj.nodeName];
    var ms = 800;

    if (data !== undefined) {
      fadeGraph();
      var g = svg.append('g').attr('width', width);
      var centerColor;

      g.selectAll('circle')
        .data([obj])
        .enter()
        .append('circle')
          .attr('fill', function(d) {
            centerColor = d.color;
            return centerColor;
          })
          .attr('cx', function(d) { return d.cx; })
          .attr('cy', function(d) { return d.y; })
          .attr('r', 4)
        .transition()
        .delay(0)
        .duration(ms)
        .attr('transform', function(d) {
          return 'translate(' + (width / 2 - d.cx) + ', 0)';
        });

      g.selectAll('line')
        .data([obj])
        .enter()
        .append('line')
          .transition()
          .delay(0)
          .duration(ms)
          .attr('style', function(d, i) {
            return 'stroke: ' + d.color;
          })
          .attr('x1', function(d) {
            return width / 2;
          })
          .attr('y1', function(d) {
            return 110;
          })
          .attr('x2', function(d) {
            return width / 2;
          })
          .attr('y2', function(d) {
            return d.y - 10;
          });

      g.selectAll('text')
        .data([obj])
        .enter()
        .append('text')
          .text(function(d, i) {
            return d.nodeName;
          })
          .attr('style', function(d, i) {
            return 'fill: ' + d.color;
          })
          .attr('y', function(d, i) { 
            if (d.group === 1) {
              return d.y + 20;
            } else {
              return d.y - 20; 
            }
          })
          .attr('x', function(d, i) { return d.cx; })
          .transition()
          .delay(0)
          .duration(ms)
          .attr('transform', function(d) {
            return 'translate(' + (width / 2 - d.cx - 120) + ', 0)';
          })
          .attr('class', 'highlight')
          .attr('y', function(d) { return 100; });

      setTimeout(function() {
        createGraph(data, g, centerColor);
      }, 2000);
    }
  };

  var draw = function() {
    var data = writers['Thomas Pynchon'];
    var nodes = data.nodes;
    var links = data.links;
    var g = svg.append('g').attr('width', width);

    var xScale = d3.scale.linear()
      .domain([0, nodes.length])
      .range([0, height]);

    var centerNode;

    // Draw nodes
    nodes.forEach(function(d, i) {
      d.x = Math.round(xScale(i)) + 50;
      d.y = 300;
      d.cx = d.x + (i * 8);
      d.color = colors(i);
      if (d.group === 0) {
        centerNode = d;
      }
    });

    g.selectAll('circle')
      .data(nodes)
      .enter()
      .append('circle')
        .attr('fill', function(d, i) {
          return d.color;
        })
        .attr('id', function(d, i) { return d.nodeName; })
        .attr('cx', function(d, i) { return d.cx; })
        .attr('cy', function(d, i) { return d.y; })
        .attr('r', 4)
        .attr('id', function(d, i) { return d.nodeName + '-circle' });

    g.selectAll('text')
      .data(nodes)
      .enter()
      .append('text')
        .text(function(d, i) {
          return d.nodeName;
        })
        .attr('style', function(d, i) {
          return 'fill: ' + d.color;
        })
        .attr('x', function(d, i) { return d.cx; })
        .attr('y', function(d, i) { 
          if (d.group === 0) {
            return 100;
          } else if (d.group === 1) {
            return d.y + 20;
          } else if (d.group === 2) {
            return d.y - 20; 
          }
        })
        .attr('transform', function(d) {
          if (d.group === 0) {
            return 'translate(' + (width / 2 - d.cx - 20) + ', 0)';
          } else if (d.group === 1) {
            return 'rotate(90 ' + (d.cx) + ',' + (d.y + 20) + ')'
          } else if (d.group === 2) {
            return 'rotate(-90 ' + (d.cx) + ',' + (d.y - 20) + ')'
          }
        })
        .attr('class', function(d) {
          if (d.group === 0) {
            return 'highlight writer';
          } else {
            return 'writer';
          }
        })
        .attr('id', function(d) { return d.nodeName + '-text' })
      .on('click', function(d) {
        redraw(d);
      })
      // .on('mouseover', function(d, i) {
      //   var current = this;
      //   var currentIndex = i;
      //   g.selectAll('text').transition().style('opacity', function() {
      //     return (this === current) ? 1 : 0.2;
      //   });

      //   g.selectAll('path').transition().style('opacity', function(d, i) {
      //     return (i === currentIndex) ? 1 : 0.2;
      //   });

      //   g.selectAll('circle').transition().style('opacity', function(d, i) {
      //     return (i === currentIndex) ? 1 : 0.2;
      //   });
      // })
      // .on('mouseleave', function(d) {
      //   d3.selectAll('text').transition().style('opacity', 1);
      //   d3.selectAll('path').transition().style('opacity', 1);
      //   d3.selectAll('circle').transition().style('opacity', 1);
      // });

    g.selectAll('line')
      .data([centerNode])
      .enter()
      .append('line')
        .attr('style', function(d, i) {
          return 'stroke: ' + d.color;
        })
        .attr('x1', function(d) {
          return d.cx;
        })
        .attr('y1', function(d) {
          return 110;
        })
        .attr('x2', function(d) {
          return d.cx;
        })
        .attr('y2', function(d) {
          return d.y - 10;
        });

    // Draw arcs
    links.forEach(function(d, i) {
      d.x = (nodes[d.source].x - nodes[d.target].x) * 1.1, 
      d.y = nodes[d.source].y - nodes[d.target].y,
      d.r = Math.sqrt(d.x * d.x + d.y * d.y)
    });

    g.selectAll('path')
      .data(links)
      .enter()
      .append('path')
        .style('fill', 'transparent')
        .style('stroke', function(d, i) {
          return colors(i);
        })
        .attr('id', function(d) { return d.nodeName + '-path'; })
        .attr('d', function(d) {
          return 'M ' + nodes[d.source].cx + ', ' + 100 + ' A ' + d.r + ' ' + d.r + ' 0 0 1' + nodes[d.target].cx + ', ' + 100;
        })
        .attr('transform', 'translate(0, 200)'); 
  };

  draw();



</script>

</body>
</html>